name: Continuous Delivery

on:
  push:
    branches:
      - master

jobs:

  terraform:

    runs-on: ubuntu-latest
    steps:

    - uses: hashicorp/setup-terraform@v3
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Terraform Init
      id: init
      run: terraform init
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # TF_ACTION_WORKING_DIR: 'terraform'
        AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color

    - name: Terraform Apply
      run: terraform apply -auto-approve
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # TF_ACTION_WORKING_DIR: 'terraform'
        AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  ansible:
 
    runs-on: ubuntu-latest
 
    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    - name: Make envfile
      uses: SpicyPizza/create-envfile@v2.0
      with:
        envkey_CHAVE_JWT: ${{ secrets.CHAVE_JWT }}
        envkey_EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
        envkey_EMAIL_SENHA: ${{ secrets.EMAIL_SENHA }}
        envkey_EMAIL_USUARIO: ${{ secrets.EMAIL_USUARIO }}
        envkey_MONGODB_HOST: ${{ secrets.MONGODB_HOST }}
        envkey_MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
        envkey_MOVIEDB_BASE_URL: ${{ secrets.MOVIEDB_BASE_URL }}
        envkey_NODE_ENV: ${{ secrets.NODE_ENV }}
        envkey_PORT: ${{ secrets.PORT }}
        envkey_REDIS_HOST: ${{ secrets.REDIS_HOST }}
        envkey_REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        envkey_REDIS_PORT: ${{ secrets.REDIS_PORT }}
        directory: ./
        file_name: .env
        fail_on_empty: false
        sort_keys: false

    - name: test SSH_PRIVATE_KEY
      run: echo ${{secrets.SSH_PRIVATE_KEY}} > ec2.pem && ssh -i "ec2.pem" ubuntu@ec2-52-88-175-223.us-west-2.compute.amazonaws.com
    - name: Run playbook
      uses: dawidd6/action-ansible-playbook@v2
      with:
        playbook: playbook.yml
        directory: ./
        key: ${{secrets.SSH_PRIVATE_KEY}}
        # # Optional, literal inventory file contents
        inventory: |
          [netflix-backend]
          52.88.175.223 ansible_user=ubuntu 
        options: |
          --verbose